#include <stdio.h>
#include <string.h>
#include <errno.h>
#include <wiringPi.h>
#include <wiringSerial.h>
	
	int fd;
	char *p_buff;
	char buff[640]= {
0xEF, 0xFF, 0xF7, 0xF7, 0xE7, 0xB7, 0xC3, 0xC3, 0xF1, 0xE1, 0xFA, 0xFA, 0xFC, 0xFC, 0xFC, 0xFC, 0xFE, 0xFF, 0xFD, 0xFD, 0xFC, 0xFC, 0xF8, 0xF8, 0xF1, 0xB0, 0x0B, 0x0B, 0x07, 0x07, 0x07, 0x07, 0xFF, 0xFF, 0xFF, 0xFF, 0xBF, 0xBF, 0x7F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x7F, 0x7F, 0x7F, 0x4E, 0x16, 0x25, 0x65, 0x67, 0x66, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1C, 0x1E, 0xC9, 0xCC, 0x09, 0x89, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF3, 0xF3, 0xF3, 0xF3, 0x33, 0x73, 0x92, 0x92, 0xF0, 0xF0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x30, 0x30, 0x6E, 0x6E, 0xF8, 0x74, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xFC, 0xFC, 0xFC, 0xE4, 0xE0, 0x48, 0x64, 0x4C, 0x4C, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC2, 0xC2, 0xB9, 0xB8, 0xE1, 0xD0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x73, 0x73, 0x67, 0x33, 0x27, 0x37, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x87, 0xCF, 0xB3, 0x12, 0x3E, 0x3E, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1C, 0x8C, 0x6C, 0x04, 0x64, 0x64, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x99, 0x01, 0x44, 0xCC, 0xCC, 0xCC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xBF, 0xFF, 0xDF, 0xDF, 0x9F, 0xDF, 0x0F, 0x0F, 0xC7, 0x86, 0xE8, 0xE8, 0xF0, 0xF0, 0xF0, 0xF0, 0xFB, 0xFF, 0xF7, 0xF7, 0xF2, 0xF2, 0xE1, 0xE1, 0xC7, 0xC3, 0x2F, 0x2F, 0x1F, 0x1F, 0x1F, 0x1F, 0xFD, 0xFF, 0xFD, 0xFD, 0xFC, 0xFC, 0xF2, 0xF2, 0xC2, 0xC2, 0xE7, 0xA7, 0xF7, 0xF7, 0xEF, 0xEF, 0xB7, 0xBF, 0x17, 0x17, 0x47, 0x47, 0x09, 0x09, 0x28, 0x28, 0xFC, 0xFC, 0xFD, 0xFD, 0xFE, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x7F, 0xBF, 0xBF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x66, 0x64, 0x64, 0x64, 0x64, 0x64, 0x66, 0x64, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x49, 0xC9, 0xC9, 0xC9, 0xCD, 0x08, 0x0C, 0x4E, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0xF0, 0xF3, 0xF0, 0x93, 0x13, 0x33, 0x73, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x72, 0xE6, 0x66, 0x26, 0x26, 0x60, 0x30, 0x92, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x4C, 0x4C, 0x4C, 0x4C, 0x48, 0x64, 0x64, 0x70, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC9, 0x99, 0x99, 0x99, 0x99, 0x81, 0xC1, 0x89, 0xFF, 0xFF, 0xFE, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x27, 0x27, 0x07, 0xAF, 0x89, 0x09, 0x89, 0x89, 0x9F, 0x9F, 0x3F, 0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0x3E, 0x3E, 0x3E, 0x3E, 0xB3, 0x02, 0x87, 0xCF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x64, 0x64, 0x64, 0x64, 0x4C, 0x24, 0x1C, 0x8C, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xF6, 0xFE, 0xF4, 0xF4, 0xF1, 0xF1, 0xC8, 0xC8, 0x08, 0x08, 0x9F, 0x9F, 0xDF, 0xDF, 0xBF, 0xBF, 0xDF, 0xFF, 0x5F, 0x5F, 0x1F, 0x1F, 0x27, 0x27, 0xA1, 0xA1, 0xF2, 0xF2, 0xF7, 0xF7, 0xFB, 0xFB, 
};
	char space[] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
	char LETTERS[][16] = {
{//A
  0x18,0x18,0x3C,0x3C,0x66,0x66,0x66,0x66,
  0x7E,0x7E,0x7E,0x7E,0x66,0x66,0x66,0x66
},
{//B
  0x78,0x78,0x64,0x64,0x64,0x64,0x78,0x78,
  0x64,0x64,0x64,0x64,0x78,0x78,0x00,0x00
},
{//C
  0x3C,0x3C,0x7C,0x7C,0x60,0x60,0x60,0x60,
  0x60,0x60,0x7C,0x7C,0x3C,0x3C,0x00,0x00
},
{//D
  0x78,0x78,0x7C,0x7C,0x66,0x66,0x66,0x66,
  0x66,0x66,0x7C,0x7C,0x78,0x78,0x00,0x00
},
{//E
  0x7C,0x7C,0x60,0x60,0x60,0x60,0x7C,0x7C,
  0x60,0x60,0x60,0x60,0x7C,0x7C,0x00,0x00
},
{//F
  0x7C,0x7C,0x7C,0x7C,0x60,0x60,0x60,0x60,
  0x78,0x78,0x60,0x60,0x60,0x60,0x00,0x00
},
{//G
  0x1E,0x1E,0x60,0x60,0x60,0x60,0x6E,0x6E,
  0x62,0x62,0x62,0x62,0x1E,0x1E,0x00,0x00
},
{//H
  0x66,0x66,0x66,0x66,0x66,0x66,0x7E,0x7E,
  0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x00
},
{//I
  0x3C,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,
  0x18,0x18,0x18,0x18,0x3C,0x3C,0x00,0x00
},
{//J
  0x1E,0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,
  0x2C,0x2C,0x2C,0x2C,0x3C,0x3C,0x00,0x00
},
{//K
  0x66,0x66,0x6C,0x6C,0x78,0x78,0x78,0x78,
  0x6C,0x6C,0x66,0x66,0x66,0x66,0x00,0x00
},
{//L
  0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,
  0x60,0x60,0x60,0x60,0x7C,0x7C,0x00,0x00
},
{//M
  0x42,0x42,0x66,0x66,0x66,0x66,0x5A,0x5A,
  0x5A,0x5A,0x42,0x42,0x42,0x42,0x00,0x00
},
{//N
  0x66,0x66,0x66,0x66,0x76,0x76,0x7E,0x7E,
  0x6E,0x6E,0x66,0x66,0x66,0x66,0x00,0x00
},
{//O
  0x18,0x18,0x24,0x24,0x66,0x66,0x66,0x66,
  0x66,0x66,0x24,0x24,0x18,0x18,0x00,0x00
},
{//P
  0x78,0x78,0x64,0x64,0x64,0x64,0x78,0x78,
  0x60,0x60,0x60,0x60,0x60,0x60,0x00,0x00
},
{//Q
  0x18,0x18,0x24,0x24,0x66,0x66,0x66,0x66,
  0x66,0x66,0x2C,0x2C,0x1E,0x1E,0x00,0x00
},
{//R
  0x78,0x78,0x64,0x64,0x64,0x64,0x78,0x78,
  0x78,0x78,0x6C,0x6C,0x64,0x64,0x00,0x00
},
{//S
  0x3C,0x3C,0x60,0x60,0x60,0x60,0x38,0x38,
  0x0C,0x0C,0x0C,0x0C,0x78,0x78,0x00,0x00
},
{//T
  0x7E,0x7E,0x7E,0x7E,0x18,0x18,0x18,0x18,
  0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x00
},
{//U
  0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,
  0x66,0x66,0x7E,0x7E,0x3C,0x3C,0x00,0x00
},
{//V
  0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,
  0x66,0x66,0x3C,0x3C,0x18,0x18,0x00,0x00
},
{//W
  0x42,0x42,0x42,0x42,0x42,0x42,0x5A,0x5A,
  0x5A,0x5A,0x7E,0x7E,0x66,0x66,0x00,0x00
},
{//X
  0x00,0x00,0x42,0x42,0x66,0x66,0x3C,0x3C,
  0x18,0x18,0x3C,0x3C,0x66,0x66,0x00,0x00
},
{//Y
  0x42,0x42,0x66,0x66,0x36,0x36,0x1C,0x1C,
  0x18,0x18,0x30,0x30,0x60,0x60,0x00,0x00
},
{//Z
  0x7E,0x7E,0x7E,0x7E,0x0E,0x0E,0x1C,0x1C,
  0x70,0x70,0x7E,0x7E,0x7E,0x7E,0x00,0x00
}
};

	
	void setTile(int n ,char tile[])
	{
		int i;
		for(i=0;i<16;i++)
		{
			buff[i+n*16]=tile[i];
		}
	}
	
	char  *getTile (char c)
	{
		if(c==' ')
		{
			 
		 return space;
		} else
		return LETTERS[c-65];
	}
	
	void waitforChar(char c)
	{
		char cmd;
		while(cmd!=c)
		{
			cmd=serialGetchar(fd);	
		}
	}
	
	void sendExposure()
	{
		serialPutchar(fd,0x01);
		serialPutchar(fd,0x00);
		serialPutchar(fd,0xE4);
		serialPutchar(fd,0x40);
	}
	
	void print(char buf[640])
	{
		serialPutchar(fd,'!');
		printf("ISSUED ! Command \n");
		waitforChar('a');
		printf("ack 1 \n");

		int i,j;
		for(i=0;i<10;i++)
		{
			printf("sending block %d \n",i+1);
			for(j=0;j<64;j++)
			{
				serialPutchar(fd,buf[i*64+j]);
				printf("%c",buf[i*64+j]);
			}
			
			if(i<9)
			{
				waitforChar('a');
				printf("block %d accepted \n",i+1);
			}
		}
		printf("blocks sent, waiting for 1 \n");
		waitforChar('1');
		sendExposure();
		printf("Exposure sent waiting for P \n");
		
		waitforChar('P');
		printf("Waiting for O \n");
		waitforChar('O');
		printf("donePrinting");
	}
	
	
	void printString(char *str, int mode)
		{
			int i;
			printf("prtStr \n");
			
			
			for(i=0;i< 40 ;i++)			
			{
				printf("sTile ");
				setTile(i,getTile(str[i]));
			}
	    	
			
			char buffInv[640];
			char cx;
			for(i=0;i<640;i++)
			{
				cx = buff[i];
				buffInv[i]= ~cx;
			}
			
			if(mode==0)
			{
			print(buff);
			}
			else
			print(buffInv);
		}
		
	int main(int argc, char **args)
	{
		int n;
		
		
		for(n=0;n<26;n++)
		{
			/*
			
			* */
			
			
			setTile(n,LETTERS[n]);
		}
		for(n=26;n<40;n++)
		{
			/*
			
			* */
			
			
			setTile(n,LETTERS[n-26]);
		}
		
		
		
		if((fd=serialOpen ("/dev/ttyAMA0",57600))<0)
		{
			printf("ERR_1");
			return 1;
		}	
		
		if(wiringPiSetup() == -1)
		{
			printf("ERR_2");
		}
		
		
		serialPutchar(fd,'?');
		printf("seeking GB Printer! \n");
		waitforChar('1');
		printf("found gbPrinter! \n");
		
		
		//print(buff);
		//printString("HALLO WELT                                          ");
		if(strcmp(args[2],"NEG") ==0)
		{
		 printString(args[1],1);
		} else
		
		printString(args[1],0);
		
		return 0;
	}
	
